<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; margin: 0; padding: 10px; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        /* HEADER */
        h1 { text-align: center; color: #333; margin: 5px 0; font-size: 22px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 10px; }
        .last-updated { font-size: 14px; color: #666; transition: color 0.5s ease; font-weight: bold; }
        .error-log { color: red; text-align: center; font-weight: bold; background: #ffe6e6; padding: 5px; display: none; margin-bottom: 10px;}

        /* TABS NAVIGATION */
        .tab-nav {
            display: flex;
            gap: 5px;
            background: #ddd;
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: #bbb;
            color: #333;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .tab-btn:hover { background: #aaa; }
        .tab-btn.active { background: #333; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* TAB CONTENT */
        .tab-content { display: none; flex-grow: 1; overflow: hidden; background: white; border: 1px solid #ccc; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
        .tab-content.active { display: flex; flex-direction: column; }

        /* SCROLLABLE TABLE */
        .table-scroll { overflow: auto; height: 100%; width: 100%; }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 14px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; border-right: 1px solid #ddd; }
        th { background-color: #444; color: white; position: sticky; top: 0; z-index: 2; border-top: none; }
        tr:last-child td { border-bottom: none; }
        
        .diverted-text { font-style: italic; font-weight: bold; color: #444; }
        .bold-time { font-weight: bold; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="last-updated" id="statusMsg">Initializing...</div>
        <h1>Flight Operations Dashboard</h1>
        <div style="width: 150px;"></div> 
    </div>
    
    <div id="errorLog" class="error-log"></div>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="openTab('flights', this)">Flight Board</button>
        <button class="tab-btn" onclick="openTab('operators', this)">Operator Turns</button>
        <button class="tab-btn" onclick="openTab('crew', this)">Crew Summary</button>
    </div>

    <div id="flights" class="tab-content active">
        <div class="table-scroll">
            <table id="flightTable">
                <thead>
                    <tr>
                        <th>Flight</th><th>Dep</th><th>Sector</th><th>Call Sign</th><th>Bay</th><th>ETA</th><th>Crew</th><th>Bowser</th><th>Comment</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="operators" class="tab-content">
        <div class="table-scroll">
            <table id="operatorTable">
                <thead>
                    <tr>
                        <th>Turn 1</th><th>Turn 2</th><th>Turn 3</th><th>Turn 4</th>
                        <th>Turn 5</th><th>Turn 6</th><th>Turn 7</th><th>Turn 8</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="crew" class="tab-content">
        <div class="table-scroll">
            <table id="crewTable">
                <thead>
                    <tr><th style="width: 30%">Crew Name</th><th>Assigned Flights</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbxNBsWw6C8Fd88j73bcfv_GJdM5Dxw5tzm0Koxwo09HVYYIbbJTyiH6ujJ4kBfgERMz/exec';
        const DATA_REFRESH_RATE = 5000;
        const PAGE_RELOAD_RATE = 600000;

        function openTab(tabId, btnElement) {
            document.querySelectorAll('.tab-content').forEach(div => div.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(btnElement) btnElement.classList.add('active');
        }

        // --- TIME HELPERS ---
        function parseFlightTime(timeInput) {
            if (!timeInput) return null;
            let str = timeInput.toString().trim();
            if (!isNaN(str) && !str.includes('T') && !str.includes(':')) {
                str = str.padStart(4, '0');
                const now = new Date();
                return new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(str.substring(0,2)), parseInt(str.substring(2,4)));
            }
            if (str.includes('T')) return new Date(str);
            return null;
        }

        function formatTimeDisplay(val) {
            if (!val) return "";
            let str = val.toString().trim();
            if (!isNaN(str) && !str.includes('T') && !str.includes(':')) {
                str = str.padStart(4, '0');
                return str.substring(0, 2) + ":" + str.substring(2, 4);
            }
            if (str.includes('T')) return str.split('T')[1].substring(0, 5);
            return str;
        }

        function formatDateToHHMM(dateObj) {
            if (!dateObj) return "";
            let h = dateObj.getHours(); let m = dateObj.getMinutes();
            return (h<10?"0"+h:h) + ":" + (m<10?"0"+m:m);
        }

        // --- FETCH DATA ---
        async function fetchData() {
            const statusMsg = document.getElementById('statusMsg');
            statusMsg.style.color = '#333';

            try {
                const response = await fetch(SHEET_API_URL);
                if (!response.ok) throw new Error("Network response was not ok");
                
                const jsonResponse = await response.json();
                const flightList = jsonResponse.flights || []; 
                const operatorList = jsonResponse.operators || [];
                const now = new Date();
                
                renderFlightTable(flightList, now);
                renderOperatorTable(operatorList);
                renderCrewSummary(flightList);

                statusMsg.textContent = 'Last updated: ' + now.toLocaleTimeString();
                setTimeout(() => { statusMsg.style.color = '#666'; }, 500);
                document.getElementById('errorLog').style.display = 'none';

            } catch (error) {
                console.error('Fetch Error:', error);
                statusMsg.textContent = 'Retrying...';
                statusMsg.style.color = 'orange';
            }
        }

        // --- RENDER FLIGHTS ---
        function renderFlightTable(list, now) {
            const tbody = document.querySelector('#flightTable tbody');
            let processedRows = [];

            list.forEach(row => {
                const rawDep = row.data[1];
                const rawEta = row.data[5];
                const rawCrew = row.data[6];
                const rawBowser = row.data[7];
                const rawComment = row.data[8] ? row.data[8].toString() : "";

                const depTime = parseFlightTime(rawDep);
                const etaTime = parseFlightTime(rawEta);
                const etaString = (typeof rawEta === 'string') ? rawEta.toUpperCase().trim() : "";
                
                const isBaseOrLanded = (etaString === 'BASE' || etaString === 'LANDED');
                const isDivert = rawComment.toLowerCase().includes('divert');

                let effectiveDepTime = null;
                let displayDepText = "";
                let isCalculated = false;

                // --- 1. TIME CALCULATION LOGIC ---
                if (isBaseOrLanded) {
                    effectiveDepTime = depTime;
                    displayDepText = formatTimeDisplay(rawDep);
                } else if (etaTime) {
                    // ETA + 40 mins
                    effectiveDepTime = new Date(etaTime.getTime() + 40 * 60000);
                    displayDepText = formatDateToHHMM(effectiveDepTime);
                    isCalculated = true;
                } else {
                    // NO ETA - AUTO DELAY LOGIC (CONTINUOUS)
                    if (depTime) {
                        // Start with the original or previously calculated time
                        let tempTime = new Date(depTime.getTime());
                        let minsUntilDep = (tempTime - now) / 60000;
                        let changed = false;

                        // WHILE the departure is within 60 mins from now (or in the past)
                        // KEEP adding 60 minutes until it's safe.
                        while (minsUntilDep <= 60) {
                            tempTime = new Date(tempTime.getTime() + 60 * 60000); // Add 60 mins
                            minsUntilDep = (tempTime - now) / 60000; // Recalculate diff
                            changed = true;
                        }

                        if (changed) {
                            effectiveDepTime = tempTime;
                            displayDepText = formatDateToHHMM(effectiveDepTime);
                            isCalculated = true;
                        } else {
                            effectiveDepTime = depTime;
                            displayDepText = formatTimeDisplay(rawDep);
                        }
                    }
                }

                // --- 2. COLOR LOGIC ---
                let rowColor = row.color !== '#ffffff' ? row.color : '#ffffff'; 
                if (rawCrew) rowColor = '#fff9c4'; 
                if (rawBowser) rowColor = '#dcedc8'; 
                
                if (effectiveDepTime) {
                    const minsToDep = (effectiveDepTime - now) / 60000;
                    if (minsToDep <= 10) rowColor = '#ffcdd2'; 
                }

                processedRows.push({
                    originalData: row.data,
                    effectiveDepTime: effectiveDepTime,
                    displayDepText: displayDepText,
                    isCalculated: isCalculated,
                    finalColor: rowColor,
                    isDivert: isDivert
                });
            });

            processedRows.sort((a, b) => {
                if (!a.effectiveDepTime) return 1;
                if (!b.effectiveDepTime) return -1;
                return a.effectiveDepTime - b.effectiveDepTime;
            });

            tbody.innerHTML = '';
            processedRows.forEach(item => {
                const tr = document.createElement('tr');
                tr.style.backgroundColor = item.finalColor;
                if (item.isDivert) tr.classList.add('diverted-text');

                item.originalData.forEach((cellData, index) => {
                    const td = document.createElement('td');
                    if (index === 1) { 
                        td.textContent = item.displayDepText;
                        if (item.isCalculated) td.classList.add('bold-time');
                    } else if (index === 5) { 
                        td.textContent = formatTimeDisplay(cellData);
                    } else {
                        td.textContent = cellData;
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        // --- RENDER OPERATORS ---
        function renderOperatorTable(list) {
            const tbody = document.querySelector('#operatorTable tbody');
            tbody.innerHTML = '';
            list.forEach(rowObj => {
                const tr = document.createElement('tr');
                rowObj.data.forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        // --- RENDER CREW ---
        function renderCrewSummary(flightList) {
            const tbody = document.querySelector('#crewTable tbody');
            const crewMap = {};

            flightList.forEach(row => {
                const flightNum = row.data[0]; 
                const crewName = row.data[6];  
                if (crewName && crewName.toString().trim() !== "") {
                    const name = crewName.toString().trim();
                    if (!crewMap[name]) crewMap[name] = [];
                    crewMap[name].push(flightNum);
                }
            });

            tbody.innerHTML = '';
            const sortedCrew = Object.keys(crewMap).sort();
            
            if (sortedCrew.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; color:#999;">No crew assigned</td></tr>';
                return;
            }

            sortedCrew.forEach(name => {
                const tr = document.createElement('tr');
                const tdName = document.createElement('td');
                tdName.textContent = name;
                tdName.style.fontWeight = 'bold';
                const tdFlights = document.createElement('td');
                tdFlights.textContent = crewMap[name].join(', ');
                tr.appendChild(tdName);
                tr.appendChild(tdFlights);
                tbody.appendChild(tr);
            });
        }

        fetchData();
        setInterval(fetchData, DATA_REFRESH_RATE);
        setTimeout(() => { window.location.reload(); }, PAGE_RELOAD_RATE);

    </script>
</body>
</html>
