<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Status Board</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 20px;
            overflow: hidden; 
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 5px;
            font-size: 24px;
        }
        .last-updated {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .table-container {
            height: 85vh; 
            overflow: auto; 
            border: 1px solid #999;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: separate; 
            border-spacing: 0;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #999; 
            border-right: 1px solid #999;
            font-size: 14px;
        }

        th {
            background-color: #333;
            color: white;
            position: sticky;
            top: 0; 
            z-index: 2; 
            border-top: none;
        }

        @media screen and (max-width: 600px) {
            table { font-size: 11px; }
            th, td { padding: 8px; }
            .table-container { height: 80vh; } 
        }
    </style>
</head>
<body>

    <h1>Flight Dep & Sector Status</h1>
    <div class="last-updated" id="statusMsg">Loading data...</div>

    <div class="table-container">
        <table id="flightTable">
            <thead>
                <tr>
                    <th>Flight</th>
                    <th>Dep</th>
                    <th>Sector</th>
                    <th>Call Sign</th>
                    <th>Bay</th>
                    <th>ETA</th>
                    <th>Crew</th>
                    <th>Bowser</th>
                    <th>Comment</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <script>
        // --- PASTE YOUR DEPLOYMENT URL HERE ---
        const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbxZ4c88cfqMzpm4nGUs5m4cEbp5QtGtNN9lQIIFVLFsMiDFJYb6MYhnN71oNaGUE9m4PQ/exec';
        // --------------------------------------

        // Helper: Parse "1415" to Date Object
        function parseFlightTime(timeInput) {
            if (!timeInput) return null;
            let str = timeInput.toString().trim();
            if (str.length === 3) str = "0" + str; 

            if (str.length === 4 && !isNaN(str)) {
                const hours = parseInt(str.substring(0, 2), 10);
                const minutes = parseInt(str.substring(2, 4), 10);
                const now = new Date();
                return new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes, 0);
            }
            if (str.includes('T')) return new Date(str);
            return null;
        }

        // Helper: Format display "1415" -> "14:15"
        function formatTimeDisplay(val) {
            if (!val) return "";
            const str = val.toString().trim();
            if (/^\d{3,4}$/.test(str)) {
                if(str.length === 4) return str.substring(0, 2) + ":" + str.substring(2, 4);
                if(str.length === 3) return "0" + str.substring(0, 1) + ":" + str.substring(1, 3);
            }
            if (str.includes('T')) return str.split('T')[1].substring(0, 5);
            return str;
        }

        // New Helper: Format Date Object -> "14:15"
        function formatDateToHHMM(dateObj) {
            if (!dateObj) return "";
            let h = dateObj.getHours();
            let m = dateObj.getMinutes();
            // Pad with zero if needed (e.g. 9 -> "09")
            const hStr = h < 10 ? "0" + h : h;
            const mStr = m < 10 ? "0" + m : m;
            return hStr + ":" + mStr;
        }

        async function fetchFlightData() {
            const statusMsg = document.getElementById('statusMsg');
            
            try {
                const response = await fetch(SHEET_API_URL);
                const flightList = await response.json();
                const tableBody = document.querySelector('#flightTable tbody');
                tableBody.innerHTML = ''; 

                const now = new Date();

                flightList.forEach(row => {
                    const tr = document.createElement('tr');
                    
                    const rawDep   = row.data[1];
                    const rawEta   = row.data[5];
                    const rawCrew  = row.data[6];
                    const rawBowser= row.data[7];

                    // --- CALCULATE TIMES ---
                    const depTimeFromSheet = parseFlightTime(rawDep);
                    const etaTime = parseFlightTime(rawEta);
                    const isBase = (typeof rawEta === 'string' && rawEta.toUpperCase().trim() === 'BASE');

                    // Calculate "Effective Departure Time"
                    let effectiveDepTime = null;
                    
                    if (isBase) {
                        effectiveDepTime = depTimeFromSheet;
                    } else if (etaTime) {
                        // Add 40 minutes to ETA
                        effectiveDepTime = new Date(etaTime.getTime() + 40 * 60000);
                    } else {
                        effectiveDepTime = depTimeFromSheet;
                    }

                    // --- COLOR LOGIC (Sequential Overrides) ---
                    
                    let rowColor = row.color !== '#ffffff' ? row.color : '#ffffff'; 

                    // 1. Blue Logic (ETA/Base)
                    if (isBase && depTimeFromSheet) {
                        const diffMins = (depTimeFromSheet - now) / (1000 * 60);
                        if (diffMins <= 75) rowColor = '#e1f5fe'; 
                    } 
                    else if (etaTime) {
                        const diffMins = (etaTime - now) / (1000 * 60);
                        if (diffMins <= 15) rowColor = '#e1f5fe'; 
                    }

                    // 2. Crew Logic (Yellow)
                    if (rawCrew && rawCrew.toString().trim() !== "") {
                        rowColor = '#fff9c4'; 
                    }

                    // 3. Bowser Logic (Green)
                    if (rawBowser && rawBowser.toString().trim() !== "") {
                        rowColor = '#dcedc8'; 
                    }

                    // 4. Departure Logic (Red)
                    if (effectiveDepTime) {
                        const diffMins = (effectiveDepTime - now) / (1000 * 60);
                        if (diffMins <= 15) {
                            rowColor = '#ffcdd2'; 
                        }
                    }

                    tr.style.backgroundColor = rowColor;

                    // --- RENDER CELLS ---
                    row.data.forEach((cellData, index) => {
                        const td = document.createElement('td');
                        
                        // DEP Column (Index 1) - REVISED LOGIC
                        if (index === 1) {
                            // If it's NOT Base, and we have an ETA, show calculated time
                            if (!isBase && etaTime && effectiveDepTime) {
                                td.textContent = formatDateToHHMM(effectiveDepTime); // Shows ETA+40
                                td.style.fontWeight = "bold"; // Make calculated time bold
                            } else {
                                td.textContent = formatTimeDisplay(cellData); // Shows Sheet Data
                            }
                        } 
                        // ETA Column (Index 5)
                        else if (index === 5) {
                            td.textContent = formatTimeDisplay(cellData);
                        } 
                        // All other columns
                        else {
                            td.textContent = cellData;
                        }
                        tr.appendChild(td);
                    });

                    tableBody.appendChild(tr);
                });

                statusMsg.textContent = 'Last updated: ' + now.toLocaleTimeString();
                statusMsg.style.color = '#666';

            } catch (error) {
                console.error('Error:', error);
                statusMsg.textContent = 'Error loading data.';
                statusMsg.style.color = 'red';
            }
        }

        fetchFlightData();
        setInterval(fetchFlightData, 30000); 
    </script>

</body>
</html>
