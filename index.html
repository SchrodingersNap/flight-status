<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Flight Dashboard</title>
    <style>
        /* --- BASE STYLES --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f4f4; margin: 0; padding: 10px; height: 100vh; display: flex; flex-direction: column; overflow: hidden;}
        
        /* HEADER AREA */
        .header-container { margin-bottom: 10px; }
        h1 { text-align: center; color: #333; margin: 5px 0; font-size: 20px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #666; margin-bottom: 5px;}
        
        /* SEARCH BAR */
        .search-container { margin-bottom: 10px; }
        #searchInput {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box; /* Ensures padding doesn't break width */
        }

        /* TABS */
        .tab-nav { display: flex; gap: 8px; background: #e0e0e0; padding: 5px; border-radius: 8px; margin-bottom: 10px; }
        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: #ccc;
            color: #444;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .tab-btn.active { background: #333; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* CONTENT AREA */
        .tab-content { display: none; flex-grow: 1; overflow: hidden; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #ddd; }
        .tab-content.active { display: flex; flex-direction: column; }
        .table-scroll { overflow-y: auto; height: 100%; width: 100%; -webkit-overflow-scrolling: touch; /* Smooth scroll on iOS */ }
        
        /* --- DESKTOP TABLE STYLES --- */
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 14px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #333; color: white; position: sticky; top: 0; z-index: 2; font-weight: 600; text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px;}
        
        /* Text Utilities */
        .diverted-text { font-style: italic; font-weight: bold; color: #444; }
        .bold-time { font-weight: bold; font-size: 1.1em; }
        .status-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; font-weight: bold; }

        /* --- MOBILE CARD VIEW (The Magic) --- */
        @media screen and (max-width: 768px) {
            body { height: auto; overflow-y: auto; } /* Allow full body scroll on mobile */
            .tab-content { height: auto; overflow: visible; border: none; box-shadow: none; background: transparent; }
            .table-scroll { overflow: visible; height: auto; }

            /* Force table to block layout */
            table, thead, tbody, th, td, tr { display: block; }
            
            /* Hide Header Row */
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            
            /* Card Style for Rows */
            tr { 
                background: white;
                margin-bottom: 15px; 
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.08);
                border: 1px solid #eee;
                overflow: hidden;
            }

            /* Cell Styles */
            td { 
                border: none;
                border-bottom: 1px solid #f0f0f0; 
                position: relative;
                padding: 10px 15px 10px 45%; /* Space for label */
                text-align: right; 
                min-height: 20px;
                display: flex;
                align-items: center;
                justify-content: flex-end;
            }
            
            /* Label Styling (Pseudo-elements) */
            td:before { 
                position: absolute;
                left: 15px;
                width: 40%; 
                white-space: nowrap;
                font-weight: bold;
                color: #666;
                text-align: left;
                font-size: 12px;
                text-transform: uppercase;
            }

            /* --- FLIGHT TABLE SPECIFIC LABELS --- */
            #flightTable td:nth-of-type(1) { background: rgba(0,0,0,0.03); justify-content: center; padding: 10px; font-size: 18px; font-weight: 800; color: #333; text-align: center; }
            #flightTable td:nth-of-type(1):before { content: ""; } /* No label for title */
            
            #flightTable td:nth-of-type(2):before { content: "Dep"; }
            #flightTable td:nth-of-type(3):before { content: "Sector"; }
            #flightTable td:nth-of-type(4):before { content: "Call Sign"; }
            #flightTable td:nth-of-type(5):before { content: "Bay"; }
            #flightTable td:nth-of-type(6):before { content: "ETA"; }
            #flightTable td:nth-of-type(7):before { content: "Crew"; }
            #flightTable td:nth-of-type(8):before { content: "Bowser"; }
            #flightTable td:nth-of-type(9):before { content: "Comment"; }

            /* --- CREW TABLE SPECIFIC LABELS --- */
            #crewTable td:nth-of-type(1) { background: rgba(0,0,0,0.03); justify-content: center; font-weight: bold; color: #333; padding-left: 15px; }
            #crewTable td:nth-of-type(1):before { content: ""; }
            
            #crewTable td:nth-of-type(2) { text-align: left; display: block; padding-left: 15px; padding-top: 30px;} 
            #crewTable td:nth-of-type(2):before { content: "Assigned Flights:"; left: 15px; top: 8px; }
        }
    </style>
</head>
<body>

    <div class="header-container">
        <h1>Flight Operations</h1>
        <div class="top-bar">
            <span id="statusMsg">Connecting...</span>
            <span style="font-size: 10px;">v3.0 Mobile</span>
        </div>
    </div>

    <div class="search-container">
        <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Search Flight, Crew, Sector...">
    </div>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="openTab('flights', this)">Flight Board</button>
        <button class="tab-btn" onclick="openTab('crew', this)">Crew Summary</button>
    </div>

    <div id="flights" class="tab-content active">
        <div class="table-scroll">
            <table id="flightTable">
                <thead>
                    <tr>
                        <th>Flight</th><th>Dep</th><th>Sector</th><th>Call Sign</th><th>Bay</th><th>ETA</th><th>Crew</th><th>Bowser</th><th>Comment</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="crew" class="tab-content">
        <div class="table-scroll">
            <table id="crewTable">
                <thead>
                    <tr>
                        <th>Crew Name</th>
                        <th>Assigned Flights</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // PASTE YOUR DEPLOYMENT URL HERE
        const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbzX64POrOcjDiH4ExaT4by-Sm_6ZubVt202AMhkwRdZdApVMsEih1wc5zmbjpETiqNRiw/exec';
        
        const DATA_REFRESH_RATE = 5000;
        const PAGE_RELOAD_RATE = 600000;

        // --- SEARCH LOGIC ---
        function filterTable() {
            const input = document.getElementById("searchInput");
            const filter = input.value.toUpperCase();
            
            // Filter Flight Table
            const flightTable = document.getElementById("flightTable");
            const flightTr = flightTable.getElementsByTagName("tr");
            for (let i = 1; i < flightTr.length; i++) { // Skip header
                const rowText = flightTr[i].textContent || flightTr[i].innerText;
                flightTr[i].style.display = rowText.toUpperCase().indexOf(filter) > -1 ? "" : "none";
            }

            // Filter Crew Table
            const crewTable = document.getElementById("crewTable");
            const crewTr = crewTable.getElementsByTagName("tr");
            for (let i = 1; i < crewTr.length; i++) {
                const rowText = crewTr[i].textContent || crewTr[i].innerText;
                crewTr[i].style.display = rowText.toUpperCase().indexOf(filter) > -1 ? "" : "none";
            }
        }

        function openTab(tabId, btnElement) {
            document.querySelectorAll('.tab-content').forEach(div => div.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(btnElement) btnElement.classList.add('active');
        }

        // --- TIME HELPERS ---
        function parseFlightTime(timeInput) {
            if (!timeInput) return null;
            let str = timeInput.toString().trim();
            if (!isNaN(str) && !str.includes('T') && !str.includes(':')) {
                str = str.padStart(4, '0');
                const now = new Date();
                return new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(str.substring(0,2)), parseInt(str.substring(2,4)));
            }
            if (str.includes('T')) return new Date(str);
            return null;
        }

        function formatTimeDisplay(val) {
            if (!val) return "";
            let str = val.toString().trim();
            if (!isNaN(str) && !str.includes('T') && !str.includes(':')) {
                str = str.padStart(4, '0');
                return str.substring(0, 2) + ":" + str.substring(2, 4);
            }
            if (str.includes('T')) return str.split('T')[1].substring(0, 5);
            return str;
        }

        function formatDateToHHMM(dateObj) {
            if (!dateObj) return "";
            let h = dateObj.getHours(); let m = dateObj.getMinutes();
            return (h<10?"0"+h:h) + ":" + (m<10?"0"+m:m);
        }

        // --- FETCH DATA ---
        async function fetchData() {
            const statusMsg = document.getElementById('statusMsg');
            
            try {
                const response = await fetch(SHEET_API_URL);
                if (!response.ok) throw new Error("Network response was not ok");
                
                const jsonResponse = await response.json();
                const flightList = jsonResponse.flights || []; 
                const now = new Date();
                
                // We only render if the user is NOT currently typing searching
                // to prevent the table from jumping while typing
                if(document.getElementById('searchInput').value === "") {
                    renderFlightTable(flightList, now);
                    renderCrewSummary(flightList);
                }

                statusMsg.textContent = 'Updated: ' + now.toLocaleTimeString();
                statusMsg.style.color = 'green';
                setTimeout(() => { statusMsg.style.color = '#666'; }, 1000);

            } catch (error) {
                console.error('Fetch Error:', error);
                statusMsg.textContent = 'Connection Error';
                statusMsg.style.color = 'red';
            }
        }

        // --- RENDER FLIGHTS ---
        function renderFlightTable(list, now) {
            const tbody = document.querySelector('#flightTable tbody');
            let processedRows = [];

            list.forEach(row => {
                const rawDep = row.data[1];
                const rawEta = row.data[5];
                const rawCrew = row.data[6];
                const rawBowser = row.data[7];
                const rawComment = row.data[8] ? row.data[8].toString() : "";

                const depTime = parseFlightTime(rawDep);
                const etaTime = parseFlightTime(rawEta);
                const etaString = (typeof rawEta === 'string') ? rawEta.toUpperCase().trim() : "";
                
                const isBaseOrLanded = (etaString === 'BASE' || etaString === 'LANDED');
                const isDivert = rawComment.toLowerCase().includes('divert');

                let effectiveDepTime = null;
                let displayDepText = "";
                let isCalculated = false;

                if (isBaseOrLanded) {
                    effectiveDepTime = depTime;
                    displayDepText = formatTimeDisplay(rawDep);
                } else if (etaTime) {
                    effectiveDepTime = new Date(etaTime.getTime() + 40 * 60000);
                    displayDepText = formatDateToHHMM(effectiveDepTime);
                    isCalculated = true;
                } else {
                    if (depTime) {
                        let tempTime = new Date(depTime.getTime());
                        let minsUntilDep = (tempTime - now) / 60000;
                        let changed = false;
                        while (minsUntilDep <= 60) {
                            tempTime = new Date(tempTime.getTime() + 60 * 60000);
                            minsUntilDep = (tempTime - now) / 60000; 
                            changed = true;
                        }
                        if (changed) {
                            effectiveDepTime = tempTime;
                            displayDepText = formatDateToHHMM(effectiveDepTime);
                            isCalculated = true;
                        } else {
                            effectiveDepTime = depTime;
                            displayDepText = formatTimeDisplay(rawDep);
                        }
                    }
                }

                let rowColor = row.color !== '#ffffff' ? row.color : '#ffffff'; 
                if (rawCrew) rowColor = '#fff9c4'; 
                if (rawBowser) rowColor = '#dcedc8'; 
                
                if (effectiveDepTime) {
                    const minsToDep = (effectiveDepTime - now) / 60000;
                    if (minsToDep <= 10) rowColor = '#ffcdd2'; 
                }

                processedRows.push({
                    originalData: row.data,
                    effectiveDepTime: effectiveDepTime,
                    displayDepText: displayDepText,
                    isCalculated: isCalculated,
                    finalColor: rowColor,
                    isDivert: isDivert
                });
            });

            processedRows.sort((a, b) => {
                if (!a.effectiveDepTime) return 1;
                if (!b.effectiveDepTime) return -1;
                return a.effectiveDepTime - b.effectiveDepTime;
            });

            tbody.innerHTML = '';
            processedRows.forEach(item => {
                const tr = document.createElement('tr');
                tr.style.backgroundColor = item.finalColor;
                if (item.isDivert) tr.classList.add('diverted-text');

                item.originalData.forEach((cellData, index) => {
                    const td = document.createElement('td');
                    if (index === 1) { 
                        td.textContent = item.displayDepText;
                        if (item.isCalculated) td.classList.add('bold-time');
                    } else if (index === 5) { 
                        td.textContent = formatTimeDisplay(cellData);
                    } else {
                        td.textContent = cellData;
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            
            // Re-apply filter if text exists
            filterTable();
        }

        // --- RENDER CREW ---
        function renderCrewSummary(flightList) {
            const tbody = document.querySelector('#crewTable tbody');
            const crewMap = {};

            flightList.forEach(row => {
                const flightNum = row.data[0]; 
                const crewName = row.data[6];  
                if (crewName && crewName.toString().trim() !== "") {
                    const name = crewName.toString().trim();
                    if (!crewMap[name]) crewMap[name] = [];
                    crewMap[name].push(flightNum);
                }
            });

            tbody.innerHTML = '';
            const sortedCrew = Object.keys(crewMap).sort();
            
            if (sortedCrew.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; color:#999; padding: 20px;">No crew assigned</td></tr>';
                return;
            }

            sortedCrew.forEach(name => {
                const tr = document.createElement('tr');
                const tdName = document.createElement('td');
                tdName.textContent = name;
                tdName.style.fontWeight = 'bold';
                const tdFlights = document.createElement('td');
                tdFlights.textContent = crewMap[name].join(', ');
                tr.appendChild(tdName);
                tr.appendChild(tdFlights);
                tbody.appendChild(tr);
            });
            
            filterTable();
        }

        fetchData();
        setInterval(fetchData, DATA_REFRESH_RATE);
        setTimeout(() => { window.location.reload(); }, PAGE_RELOAD_RATE);

    </script>
</body>
</html>
