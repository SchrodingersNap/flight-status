<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Status Board</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 20px;
            overflow: hidden; 
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 5px;
            font-size: 24px;
        }
        .last-updated {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
        }
        
        /* Table Container */
        .table-container {
            height: 85vh; 
            overflow: auto; 
            border: 1px solid #999;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: separate; 
            border-spacing: 0;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #999; 
            border-right: 1px solid #999;
            font-size: 14px;
        }

        /* Sticky Header */
        th {
            background-color: #333;
            color: white;
            position: sticky;
            top: 0; 
            z-index: 2; 
            border-top: none;
        }

        @media screen and (max-width: 600px) {
            table { font-size: 11px; }
            th, td { padding: 8px; }
            .table-container { height: 80vh; } 
        }
    </style>
</head>
<body>

    <h1>Flight Dep & Sector Status</h1>
    <div class="last-updated" id="statusMsg">Loading data...</div>

    <div class="table-container">
        <table id="flightTable">
            <thead>
                <tr>
                    <th>Flight</th>
                    <th>Dep</th>
                    <th>Sector</th>
                    <th>Call Sign</th>
                    <th>Bay</th>
                    <th>ETA</th>
                    <th>Crew</th>
                    <th>Bowser</th>
                    <th>Comment</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <script>
        // --- PASTE YOUR DEPLOYMENT URL HERE ---
        const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbxZ4c88cfqMzpm4nGUs5m4cEbp5QtGtNN9lQIIFVLFsMiDFJYb6MYhnN71oNaGUE9m4PQ/exec';
        // --------------------------------------

        // 1. Helper to Parse "1415" into a real Date object for comparison
        function parseFlightTime(timeInput) {
            if (!timeInput) return null;
            
            let str = timeInput.toString().trim();

            // Handle 3 digits (e.g. "930" -> "0930") just in case
            if (str.length === 3) str = "0" + str;

            // Check if it is the HHMM format
            if (str.length === 4 && !isNaN(str)) {
                const hours = parseInt(str.substring(0, 2), 10);
                const minutes = parseInt(str.substring(2, 4), 10);
                
                const now = new Date();
                // Create a date object for TODAY with this time
                return new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes, 0);
            }
            
            // Fallback: If it's a full Date string
            if (str.includes('T')) return new Date(str);
            
            return null;
        }

        // 2. Helper to display "1415" as "14:15" visually
        function formatTimeDisplay(val) {
            if (!val) return "";
            const str = val.toString().trim();
            // If it looks like HHMM, insert a colon
            if (/^\d{3,4}$/.test(str)) {
                if(str.length === 4) return str.substring(0, 2) + ":" + str.substring(2, 4);
                if(str.length === 3) return "0" + str.substring(0, 1) + ":" + str.substring(1, 3);
            }
            // If it's a long date string, cut it short
            if (str.includes('T')) {
                return str.split('T')[1].substring(0, 5);
            }
            return str;
        }

        async function fetchFlightData() {
            const statusMsg = document.getElementById('statusMsg');
            
            try {
                const response = await fetch(SHEET_API_URL);
                const flightList = await response.json();
                
                const tableBody = document.querySelector('#flightTable tbody');
                tableBody.innerHTML = ''; 

                const now = new Date();

                flightList.forEach(row => {
                    const tr = document.createElement('tr');
                    
                    // Column Indexes: 0:Flight, 1:Dep, 2:Sec, 3:Call, 4:Bay, 5:ETA, 6:Crew, 7:Bowser, 8:Comment
                    const rawDep   = row.data[1];
                    const rawEta   = row.data[5];
                    const rawCrew  = row.data[6];
                    const rawBowser= row.data[7];

                    // --- COLOR LOGIC ---
                    let rowColor = row.color !== '#ffffff' ? row.color : '#ffffff'; 

                    // 1. Crew (Yellow)
                    if (rawCrew && rawCrew.toString().trim() !== "") {
                        rowColor = '#fff9c4'; 
                    }

                    // 2. Bowser (Green)
                    if (rawBowser && rawBowser.toString().trim() !== "") {
                        rowColor = '#dcedc8'; 
                    }

                    // Parse times for alerts
                    const depTime = parseFlightTime(rawDep);
                    const etaTime = parseFlightTime(rawEta);

                    // 3. Arrival/Base Logic (Blue)
                    // Check if ETA column specifically says "BASE"
                    const isBase = (typeof rawEta === 'string' && rawEta.toUpperCase().trim() === 'BASE');
                    
                    if (isBase && depTime) {
                        // BASE Logic: If within 75 mins of DEP
                        const diffMs = depTime - now; 
                        const diffMins = diffMs / (1000 * 60);
                        if (diffMins <= 75) rowColor = '#e1f5fe'; 
                    } 
                    else if (etaTime) {
                        // ETA Logic: If within 15 mins of ETA
                        const diffMs = etaTime - now;
                        const diffMins = diffMs / (1000 * 60);
                        if (diffMins <= 15) rowColor = '#e1f5fe';
                    }

                    // 4. Departure Logic (Red) - Highest Priority Alert
                    if (depTime) {
                        const diffMs = depTime - now;
                        const diffMins = diffMs / (1000 * 60);
                        // If time to departure is 15 mins or less (or past departure)
                        if (diffMins <= 15) rowColor = '#ffcdd2'; 
                    }

                    tr.style.backgroundColor = rowColor;

                    // --- RENDER CELLS ---
                    row.data.forEach((cellData, index) => {
                        const td = document.createElement('td');
                        
                        // Apply formatting to DEP (index 1) and ETA (index 5)
                        if (index === 1 || index === 5) {
                            td.textContent = formatTimeDisplay(cellData);
                        } else {
                            td.textContent = cellData;
                        }
                        tr.appendChild(td);
                    });

                    tableBody.appendChild(tr);
                });

                statusMsg.textContent = 'Last updated: ' + now.toLocaleTimeString();
                statusMsg.style.color = '#666';

            } catch (error) {
                console.error('Error fetching data:', error);
                statusMsg.textContent = 'Error: Could not refresh data.';
                statusMsg.style.color = 'red';
            }
        }

        fetchFlightData();
        setInterval(fetchFlightData, 30000); 
    </script>

</body>
</html>
