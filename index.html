<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
    <title>Flight Ops</title>
    <style>
        /* --- 1. PERFORMANCE BASE --- */
        :root {
            --primary: #263238;
            --accent: #29b6f6;
            --bg: #f4f6f8;
            --danger: #d32f2f;
            --success: #388e3c;
            --warning: #fbc02d;
            --card-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg); 
            margin: 0; padding: 8px; height: 100vh; 
            display: flex; flex-direction: column; overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }
        
        /* HEADER */
        .header-container { margin-bottom: 5px; text-align: center; flex-shrink: 0;}
        h1 { margin: 0; font-size: 16px; font-weight: 800; color: var(--primary); text-transform: uppercase; }
        .top-status { font-size: 10px; color: #78909c; font-weight: 600; margin-top: 2px;}

        /* TABS */
        .tab-nav { 
            display: flex; gap: 8px; background: #dfe6e9; padding: 4px; 
            border-radius: 12px; margin-bottom: 10px; flex-shrink: 0; 
        }
        .tab-btn {
            flex: 1; padding: 12px 0; border: none; background: transparent; 
            color: #607d8b; font-size: 13px; font-weight: 700; 
            cursor: pointer; border-radius: 8px; transition: background 0.2s;
        }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tab-btn[onclick*="running"].active { background: var(--success); color: white; }

        /* CONTENT */
        .tab-content { display: none; flex-grow: 1; overflow: hidden; background: white; border-radius: 8px; border: 1px solid #e0e0e0; }
        .tab-content.active { display: flex; flex-direction: column; }
        .table-scroll { overflow-y: auto; height: 100%; width: 100%; -webkit-overflow-scrolling: touch; }
        
        /* EXCEL VIEW */
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 12px; min-width: 800px; }
        th, td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #eee; border-right: 1px solid #eee; }
        th { background-color: var(--primary); color: white; position: sticky; top: 0; z-index: 2; }
        
        /* --- MOBILE RUNNING VIEW --- */
        .running-container { 
            padding: 10px; background: #eceff1; overflow-y: auto; height: 100%; 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 12px; align-content: start;
        }

        .bay-card {
            background: white; border-radius: 12px; 
            box-shadow: var(--card-shadow);
            display: flex; flex-direction: column;
            border-left: 5px solid var(--primary);
            position: relative;
        }

        /* CARD HEADER */
        .card-header {
            padding: 10px 12px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #f0f0f0;
            background: white;
            border-top-right-radius: 12px;
        }
        
        .bay-badge { 
            font-size: 18px; font-weight: 900; color: var(--primary);
            background: #eceff1; padding: 4px 8px; border-radius: 6px;
        }

        .bowser-pill { 
            background: #e8f5e9; color: #2e7d32; padding: 6px 12px; 
            border-radius: 20px; font-weight: 800; font-size: 15px; 
            display: flex; align-items: center; gap: 6px; border: 1px solid #c8e6c9;
        }
        .truck-icon { font-size: 18px; filter: drop-shadow(0 1px 1px rgba(0,0,0,0.1)); }

        /* CARD BODY */
        .card-body { padding: 12px; display: grid; grid-template-columns: 1.5fr 1fr; gap: 8px 12px; }
        
        .label { font-size: 9px; color: #90a4ae; text-transform: uppercase; font-weight: 700; margin-bottom: 2px; }
        .val { font-size: 14px; font-weight: 600; color: #37474f; }
        .flight-big { font-size: 22px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; line-height: 1; }
        
        /* 95% WIDGET */
        .stat-box {
            grid-column: 1 / -1;
            background: #e3f2fd; border: 1px solid #bbdefb;
            padding: 8px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 5px;
        }
        .stat-val { font-size: 18px; color: #1565c0; font-weight: 900; }
        .dep-time { font-size: 16px; font-weight: 700; color: #37474f; }
        
        /* FOOTER */
        .card-footer {
            background: #fafafa; padding: 8px 12px; border-top: 1px solid #eee;
            font-size: 12px; color: #607d8b; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px;
        }

        /* --- PRIORITY / WARNING STYLES --- */
        .card-urgent { 
            border-left-color: #d32f2f !important; 
            box-shadow: 0 0 15px rgba(211, 47, 47, 0.3);
            animation: pulse-red 2s infinite;
        }
        .urgent-banner {
            grid-column: 1 / -1;
            background: #d32f2f; color: white;
            font-weight: 900; text-align: center; padding: 6px;
            border-radius: 4px; font-size: 12px; letter-spacing: 0.5px;
            animation: blink 1s infinite alternate;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .dep-time.urgent { color: #d32f2f; font-weight: 900; font-size: 18px; }

        /* DIVERT HAZARD STYLE */
        .card-divert { border-left-color: #ff8f00 !important; }
        .card-divert .card-header {
            background: repeating-linear-gradient(45deg, #ffb300, #ffb300 10px, #ffca28 10px, #ffca28 20px);
        }
        .card-divert .bay-badge { background: white; color: black; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .card-divert .bowser-pill { background: black; color: #ffca28; border: 2px solid #ffca28; }
        
        .divert-msg {
            grid-column: 1 / -1; background: #fff3e0; color: #e65100;
            padding: 10px; font-weight: bold; font-size: 14px; text-align: center;
            border-radius: 4px; border: 1px solid #ffe0b2; margin-bottom: 5px;
            line-height: 1.4; display: flex; align-items: center; justify-content: center; gap: 5px;
        }

        @keyframes blink { from { opacity: 1; } to { opacity: 0.7; } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(211, 47, 47, 0); } 100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); } }
        
        @media (max-width: 350px) { .running-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="header-container">
        <h1>Flight Operations</h1>
        <div class="top-status">
            <span id="statusMsg">Syncing...</span> ‚Ä¢ <span id="activeCount">0 Active</span>
        </div>
    </div>

    <div class="tab-nav">
        <button class="tab-btn" onclick="openTab('flights', this)">List View</button>
        <button class="tab-btn active" onclick="openTab('running', this)">RUNNING BAYS</button>
        <button class="tab-btn" onclick="openTab('crew', this)">Crew</button>
    </div>

    <div id="flights" class="tab-content">
        <div class="table-scroll">
            <table id="flightTable">
                <thead>
                    <tr>
                        <th>Flight</th><th>Dep</th><th>Sector</th><th>95%</th><th>Call Sign</th><th>Bay</th><th>ETA</th><th>Crew</th><th>Bowser</th><th>Comment</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="running" class="tab-content active">
        <div class="running-container" id="runningContainer">
            <div style="grid-column:1/-1; text-align: center; padding: 40px; color: #b0bec5;">
                <div style="font-size: 40px;">üöõ</div>
                <p>No Active Bowsers</p>
            </div>
        </div>
    </div>

    <div id="crew" class="tab-content">
        <div class="table-scroll">
            <table id="crewTable">
                <thead>
                    <tr><th style="width: 40%">Crew Name</th><th>Flights</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbwIIupWAoxwag1v8qckNWxGpw65g94Xj_HICrcG7S2jhcHNxrrVkDoFIRDx50xT1sCCXQ/exec';        
        const DATA_REFRESH_RATE = 5000;
        const PAGE_RELOAD_RATE = 600000;

        function openTab(tabId, btnElement) {
            document.querySelectorAll('.tab-content').forEach(div => div.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(btnElement) btnElement.classList.add('active');
        }

        function parseFlightTime(timeInput) {
            if (!timeInput) return null;
            let str = timeInput.toString().trim();
            if (!isNaN(str) && !str.includes('T') && !str.includes(':')) {
                str = str.padStart(4, '0');
                const now = new Date();
                return new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(str.substring(0,2)), parseInt(str.substring(2,4)));
            }
            if (str.includes('T')) return new Date(str);
            return null;
        }

        function formatTimeDisplay(val) {
            if (!val) return "";
            let str = val.toString().trim();
            if (!isNaN(str) && !str.includes('T') && !str.includes(':')) {
                str = str.padStart(4, '0');
                return str.substring(0, 2) + ":" + str.substring(2, 4);
            }
            if (str.includes('T')) return str.split('T')[1].substring(0, 5);
            return str;
        }

        function formatDateToHHMM(dateObj) {
            if (!dateObj) return "";
            let h = dateObj.getHours(); let m = dateObj.getMinutes();
            return (h<10?"0"+h:h) + ":" + (m<10?"0"+m:m);
        }

        async function fetchData() {
            const statusMsg = document.getElementById('statusMsg');
            try {
                const response = await fetch(SHEET_API_URL);
                if (!response.ok) throw new Error("Net Err");
                
                const jsonResponse = await response.json();
                const flightList = jsonResponse.flights || []; 
                const now = new Date();
                
                const processedData = processFlightData(flightList, now);

                renderMasterBoard(processedData);
                renderMobileRunningView(processedData); 
                renderCrewSummary(flightList);

                statusMsg.textContent = 'Live ' + now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                statusMsg.style.color = '#2e7d32';

            } catch (error) {
                console.error(error);
                statusMsg.textContent = 'Offline';
                statusMsg.style.color = '#c62828';
            }
        }

        function processFlightData(list, now) {
            return list.map(row => {
                const rawFlight = row.data[0];
                const rawDep = row.data[1];
                const rawSector = row.data[2];
                const rawPercent = row.data[3];
                const rawCall = row.data[4];
                const rawBay = row.data[5];
                const rawEta = row.data[6];
                const rawCrew = row.data[7];
                const rawBowser = row.data[8];
                const rawComment = row.data[9] ? row.data[9].toString() : "";

                const depTime = parseFlightTime(rawDep);
                const etaTime = parseFlightTime(rawEta);
                const etaString = (typeof rawEta === 'string') ? rawEta.toUpperCase().trim() : "";
                const isBaseOrLanded = (etaString === 'BASE' || etaString === 'LANDED');
                const isDivert = rawComment.toLowerCase().includes('divert');

                let effectiveDepTime = null;
                let displayDepText = "";
                let isCalculated = false;

                if (isBaseOrLanded) {
                    effectiveDepTime = depTime;
                    displayDepText = formatTimeDisplay(rawDep);
                } else if (etaTime) {
                    effectiveDepTime = new Date(etaTime.getTime() + 40 * 60000);
                    displayDepText = formatDateToHHMM(effectiveDepTime);
                    isCalculated = true;
                } else {
                    if (depTime) {
                        let tempTime = new Date(depTime.getTime());
                        let minsUntilDep = (tempTime - now) / 60000;
                        let changed = false;
                        while (minsUntilDep <= 60) {
                            tempTime = new Date(tempTime.getTime() + 60 * 60000);
                            minsUntilDep = (tempTime - now) / 60000; 
                            changed = true;
                        }
                        if (changed) {
                            effectiveDepTime = tempTime;
                            displayDepText = formatDateToHHMM(effectiveDepTime);
                            isCalculated = true;
                        } else {
                            effectiveDepTime = depTime;
                            displayDepText = formatTimeDisplay(rawDep);
                        }
                    }
                }

                let rowColor = row.color !== '#ffffff' ? row.color : '#ffffff'; 
                if (rawCrew) rowColor = '#fff9c4'; 
                if (rawBowser) rowColor = '#dcedc8'; 
                
                // --- URGENCY LOGIC (20 MINS) ---
                let isUrgent = false;
                let minsToDep = 0;
                
                if (effectiveDepTime) {
                    minsToDep = (effectiveDepTime - now) / 60000;
                    
                    // If between 0 and 20 mins, trigger Warning
                    if (minsToDep <= 20 && minsToDep > -15) {
                        rowColor = '#ffcdd2';
                        isUrgent = true;
                    }
                }

                return {
                    originalData: row.data,
                    flightNo: rawFlight,
                    sector: rawSector,
                    percentile: rawPercent, 
                    callSign: rawCall,
                    bay: rawBay,
                    crew: rawCrew,
                    bowser: rawBowser,
                    comment: rawComment,
                    effectiveDepTime: effectiveDepTime,
                    displayDepText: displayDepText,
                    isCalculated: isCalculated,
                    finalColor: rowColor,
                    isDivert: isDivert,
                    isUrgent: isUrgent,
                    minsToDep: minsToDep // Pass this for display
                };
            }).sort((a, b) => {
                if (!a.effectiveDepTime) return 1;
                if (!b.effectiveDepTime) return -1;
                return a.effectiveDepTime - b.effectiveDepTime;
            });
        }

        function renderMasterBoard(processedData) {
            const tbody = document.querySelector('#flightTable tbody');
            tbody.innerHTML = '';
            processedData.forEach(item => {
                const tr = document.createElement('tr');
                tr.style.backgroundColor = item.finalColor;
                if (item.isDivert) { tr.style.color = '#d32f2f'; tr.style.fontStyle = "italic"; }

                const colData = [
                    item.flightNo, item.displayDepText, item.sector, item.percentile, 
                    item.callSign, item.bay, formatTimeDisplay(item.originalData[6]), 
                    item.crew, item.bowser, item.comment
                ];

                colData.forEach((cellData, index) => {
                    const td = document.createElement('td');
                    if (index === 1 && item.isCalculated) td.style.fontWeight = 'bold';
                    if (index === 3) { td.style.fontWeight = "bold"; td.style.color = "#1565c0"; }
                    td.textContent = cellData;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function renderMobileRunningView(processedData) {
            const container = document.getElementById('runningContainer');
            const runningFlights = processedData.filter(item => item.bowser && item.bowser.toString().trim() !== "");
            
            document.getElementById('activeCount').textContent = runningFlights.length + " Active";

            if (runningFlights.length === 0) {
                container.innerHTML = '<div style="grid-column:1/-1; text-align: center; padding: 50px; color: #b0bec5;"><div style="font-size: 40px; margin-bottom: 10px;">üöõ</div><h3>No Active Bowsers</h3></div>';
                return;
            }

            container.innerHTML = '';
            
            runningFlights.forEach(item => {
                const card = document.createElement('div');
                card.className = item.isDivert ? 'bay-card card-divert' : 'bay-card';
                
                // If Urgent (and not diverted), add Urgent styling
                if(item.isUrgent && !item.isDivert) {
                    card.classList.add('card-urgent');
                }

                const bayDisplay = item.bay ? item.bay : "--";
                
                // --- URGENCY BANNER (20 MIN) ---
                let urgentBanner = '';
                if(item.isUrgent) {
                    const timeMsg = item.minsToDep < 1 ? "NOW" : Math.ceil(item.minsToDep) + " MIN";
                    urgentBanner = `<div class="urgent-banner">üî• EXPEDITE: DEP IN ${timeMsg}</div>`;
                }

                // --- SMART DIVERT ---
                let divertMsg = '';
                if (item.isDivert) {
                    let msgText = "‚ö†Ô∏è DIVERT INSTRUCTION";
                    const match = item.comment.match(/DIVERT TO[:\s]+([A-Z0-9]+)/i);
                    if (match && match[1]) {
                        const targetBay = match[1].trim().toUpperCase();
                        const currentIndex = processedData.indexOf(item);
                        const rowsBelow = processedData.slice(currentIndex + 1);
                        const targetFlight = rowsBelow.find(f => 
                            f.bay && f.bay.toString().toUpperCase() === targetBay
                        );
                        if (targetFlight) {
                            msgText = `‚ö†Ô∏è DIVERT BOWSER TO: ${targetFlight.flightNo}/${targetFlight.sector}/${targetFlight.bay}`;
                        } else {
                            msgText = `‚ö†Ô∏è DIVERT BOWSER TO: BAY ${targetBay} (No Future Flight)`;
                        }
                    } else {
                        msgText = "‚ö†Ô∏è DIVERT: See Comment";
                    }
                    divertMsg = `<div class="divert-msg">${msgText}</div>`;
                }

                card.innerHTML = `
                    <div class="card-header">
                        <span class="bay-badge">BAY ${bayDisplay}</span>
                        <span class="bowser-pill"><span class="truck-icon">üöõ</span> ${item.bowser}</span>
                    </div>
                    
                    <div class="card-body">
                        ${urgentBanner}
                        ${divertMsg}
                        
                        <div>
                            <div class="label">FLIGHT</div>
                            <div class="flight-big">${item.flightNo}</div>
                        </div>
                        
                        <div style="text-align:right;">
                            <div class="label">CALL SIGN</div>
                            <div class="val">${item.callSign}</div>
                        </div>

                        <div class="stat-box">
                            <div>
                                <div class="label" style="color:#1565c0">95th %</div>
                                <div class="stat-val">${item.percentile || "--"}</div>
                            </div>
                            <div style="text-align:right;">
                                <div class="label" style="color:#1565c0">DEPARTURE</div>
                                <div class="dep-time ${item.isUrgent ? 'urgent' : ''}">${item.displayDepText}</div>
                            </div>
                        </div>

                        <div>
                            <div class="label">SECTOR</div>
                            <div class="val">üìç ${item.sector}</div>
                        </div>
                        
                        <div style="text-align:right;">
                            <div class="label">CREW</div>
                            <div class="val">${item.crew || '--'}</div>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        ${item.comment ? "üìù " + item.comment : "No instructions"}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderCrewSummary(flightList) {
            const tbody = document.querySelector('#crewTable tbody');
            const crewMap = {};
            flightList.forEach(row => {
                const flightNum = row.data[0]; 
                const crewName = row.data[7]; 
                if (crewName && crewName.toString().trim() !== "") {
                    const name = crewName.toString().trim();
                    if (!crewMap[name]) crewMap[name] = [];
                    crewMap[name].push(flightNum);
                }
            });

            tbody.innerHTML = '';
            const sortedCrew = Object.keys(crewMap).sort();
            if (sortedCrew.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; color:#999; padding:20px;">No crew assigned</td></tr>';
                return;
            }
            sortedCrew.forEach(name => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td style="font-weight:bold; color:#37474f;">${name}</td><td>${crewMap[name].join(', ')}</td>`;
                tbody.appendChild(tr);
            });
        }

        fetchData();
        setInterval(fetchData, DATA_REFRESH_RATE);
        setTimeout(() => { window.location.reload(); }, PAGE_RELOAD_RATE);

    </script>
</body>
</html>
