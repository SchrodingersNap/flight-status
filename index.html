<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Flight Dashboard</title>
    <style>
        /* --- BASE STYLES --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #eef2f5; margin: 0; padding: 10px; height: 100vh; display: flex; flex-direction: column; overflow: hidden;}
        
        .header-container { margin-bottom: 5px; }
        h1 { text-align: center; color: #333; margin: 5px 0; font-size: 18px; }
        .top-status { text-align: center; font-size: 11px; color: #666; margin-bottom: 8px; }

        /* TABS */
        .tab-nav { display: flex; gap: 8px; background: #dcdcdc; padding: 4px; border-radius: 8px; margin-bottom: 10px; flex-shrink: 0; }
        .tab-btn {
            flex: 1;
            padding: 12px 5px;
            border: none;
            background: #bbb;
            color: #444;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 6px;
            white-space: nowrap;
        }
        .tab-btn.active { background: #333; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .tab-btn[onclick*="running"] { background: #2e7d32; color: white; }
        .tab-btn[onclick*="running"].active { background: #1b5e20; box-shadow: inset 0 0 5px rgba(0,0,0,0.5); border: 2px solid #fff; }

        .tab-content { display: none; flex-grow: 1; overflow: hidden; background: white; border-radius: 4px; border: 1px solid #ccc; }
        .tab-content.active { display: flex; flex-direction: column; }
        .table-scroll { overflow: auto; height: 100%; width: 100%; -webkit-overflow-scrolling: touch; }
        
        /* EXCEL VIEW */
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; min-width: 900px; }
        th, td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #eee; border-right: 1px solid #eee; white-space: nowrap; }
        th { background-color: #333; color: white; position: sticky; top: 0; z-index: 2; font-weight: 600; font-size: 12px; }
        
        /* RUNNING CARD VIEW */
        .running-container { padding: 10px; background: #eef2f5; overflow-y: auto; height: 100%; }

        .bay-card {
            background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 15px; border-left: 8px solid #333; position: relative; overflow: hidden;
        }

        .bay-header {
            background: #333; color: white; padding: 10px 15px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .bay-title { font-size: 24px; font-weight: 800; letter-spacing: 1px; }
        .bay-bowser { background: #fff; color: #333; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 14px; }

        .bay-body { padding: 12px 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .info-group label { display: block; font-size: 10px; color: #888; text-transform: uppercase; font-weight: bold; }
        .info-group span { display: block; font-size: 16px; font-weight: 600; color: #222; }
        
        .stat-highlight { grid-column: 1 / -1; background: #e3f2fd; padding: 8px; border-radius: 6px; border: 1px solid #bbdefb; display: flex; justify-content: space-between; align-items: center;}
        .stat-val { color: #1565c0; font-weight: 900; font-size: 18px !important;}
        
        .crew-highlight { grid-column: 1 / -1; background: #fffde7; padding: 8px; border-radius: 6px; border: 1px solid #fff9c4; }

        .bay-footer { background: #f9f9f9; padding: 10px 15px; border-top: 1px solid #eee; font-size: 14px; color: #555; font-style: italic; }

        .divert-card { border-left-color: #d32f2f; }
        .divert-card .bay-header { background: #d32f2f; }
        .divert-alert {
            background: #ffebee; color: #b71c1c; padding: 10px; margin: 10px 15px 0 15px;
            border-radius: 5px; border: 1px solid #ffcdd2; font-weight: bold; font-size: 14px;
        }

        .diverted-text { font-style: italic; font-weight: bold; color: #444; }
        .bold-time { font-weight: bold; font-size: 1.1em; }
        .copy-hint { font-size: 9px; color: #aaa; font-weight: normal; margin-left: 5px; cursor: pointer; text-decoration: underline;}

    </style>
</head>
<body>

    <div class="header-container">
        <h1>Flight Operations</h1>
        <div class="top-status">
            <span id="statusMsg">Connecting...</span> | <span id="activeCount">0 Running</span>
        </div>
    </div>

    <div class="tab-nav">
        <button class="tab-btn" onclick="openTab('flights', this)">Master Board</button>
        <button class="tab-btn active" onclick="openTab('running', this)">RUNNING BAYS</button>
        <button class="tab-btn" onclick="openTab('crew', this)">Crew</button>
    </div>

    <div id="flights" class="tab-content">
        <div class="table-scroll">
            <table id="flightTable">
                <thead>
                    <tr>
                        <th>Flight</th>     <th>Dep</th>        <th>Sector</th>     <th>95th %</th>     <th>Call Sign</th>  <th>Bay</th>        <th>ETA</th>        <th>Crew</th>       <th>Bowser</th>     <th>Comment</th>    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="running" class="tab-content active">
        <div class="running-container" id="runningContainer">
            <div style="text-align: center; padding: 20px; color: #999;">Waiting for Bowser Assignment...</div>
        </div>
    </div>

    <div id="crew" class="tab-content">
        <div class="table-scroll">
            <table id="crewTable">
                <thead>
                    <tr><th style="width: 30%">Crew Name</th><th>Assigned Flights</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        // --- PASTE YOUR URL HERE ---
        const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbwIIupWAoxwag1v8qckNWxGpw65g94Xj_HICrcG7S2jhcHNxrrVkDoFIRDx50xT1sCCXQ/exec';
        // ---------------------------
        
        const DATA_REFRESH_RATE = 5000;
        const PAGE_RELOAD_RATE = 600000;

        function openTab(tabId, btnElement) {
            document.querySelectorAll('.tab-content').forEach(div => div.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(btnElement) btnElement.classList.add('active');
        }

        function parseFlightTime(timeInput) {
            if (!timeInput) return null;
            let str = timeInput.toString().trim();
            if (!isNaN(str) && !str.includes('T') && !str.includes(':')) {
                str = str.padStart(4, '0');
                const now = new Date();
                return new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(str.substring(0,2)), parseInt(str.substring(2,4)));
            }
            if (str.includes('T')) return new Date(str);
            return null;
        }

        function formatTimeDisplay(val) {
            if (!val) return "";
            let str = val.toString().trim();
            if (!isNaN(str) && !str.includes('T') && !str.includes(':')) {
                str = str.padStart(4, '0');
                return str.substring(0, 2) + ":" + str.substring(2, 4);
            }
            if (str.includes('T')) return str.split('T')[1].substring(0, 5);
            return str;
        }

        function formatDateToHHMM(dateObj) {
            if (!dateObj) return "";
            let h = dateObj.getHours(); let m = dateObj.getMinutes();
            return (h<10?"0"+h:h) + ":" + (m<10?"0"+m:m);
        }
        
        function formatCleanFlight(flightStr) {
            if(!flightStr) return "";
            return flightStr.toString().replace(/[^a-zA-Z0-9]/g, "").toLowerCase();
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert("Copied " + text + " for search!");
            });
        }

        async function fetchData() {
            const statusMsg = document.getElementById('statusMsg');
            try {
                const response = await fetch(SHEET_API_URL);
                if (!response.ok) throw new Error("Network response was not ok");
                
                const jsonResponse = await response.json();
                const flightList = jsonResponse.flights || []; 
                const now = new Date();
                
                const processedData = processFlightData(flightList, now);

                renderMasterBoard(processedData);
                renderRunningView(processedData); 
                renderCrewSummary(flightList);

                statusMsg.textContent = 'Updated: ' + now.toLocaleTimeString();
                statusMsg.style.color = 'green';
                setTimeout(() => { statusMsg.style.color = '#666'; }, 1000);

            } catch (error) {
                console.error('Fetch Error:', error);
                statusMsg.textContent = 'Connection Error';
                statusMsg.style.color = 'red';
            }
        }

        function processFlightData(list, now) {
            return list.map(row => {
                // --- NEW COLUMN MAPPING BASED ON YOUR IMAGE ---
                const rawFlight  = row.data[0]; // A
                const rawDep     = row.data[1]; // B
                const rawSector  = row.data[2]; // C
                const rawPercent = row.data[3]; // D (The 95% Column)
                const rawCall    = row.data[4]; // E
                const rawBay     = row.data[5]; // F
                const rawEta     = row.data[6]; // G
                const rawCrew    = row.data[7]; // H
                const rawBowser  = row.data[8]; // I
                const rawComment = row.data[9] ? row.data[9].toString() : ""; // J

                const depTime = parseFlightTime(rawDep);
                const etaTime = parseFlightTime(rawEta);
                const etaString = (typeof rawEta === 'string') ? rawEta.toUpperCase().trim() : "";
                
                const isBaseOrLanded = (etaString === 'BASE' || etaString === 'LANDED');
                const isDivert = rawComment.toLowerCase().includes('divert');

                let effectiveDepTime = null;
                let displayDepText = "";
                let isCalculated = false;

                if (isBaseOrLanded) {
                    effectiveDepTime = depTime;
                    displayDepText = formatTimeDisplay(rawDep);
                } else if (etaTime) {
                    effectiveDepTime = new Date(etaTime.getTime() + 40 * 60000);
                    displayDepText = formatDateToHHMM(effectiveDepTime);
                    isCalculated = true;
                } else {
                    if (depTime) {
                        let tempTime = new Date(depTime.getTime());
                        let minsUntilDep = (tempTime - now) / 60000;
                        let changed = false;
                        while (minsUntilDep <= 60) {
                            tempTime = new Date(tempTime.getTime() + 60 * 60000);
                            minsUntilDep = (tempTime - now) / 60000; 
                            changed = true;
                        }
                        if (changed) {
                            effectiveDepTime = tempTime;
                            displayDepText = formatDateToHHMM(effectiveDepTime);
                            isCalculated = true;
                        } else {
                            effectiveDepTime = depTime;
                            displayDepText = formatTimeDisplay(rawDep);
                        }
                    }
                }

                let rowColor = row.color !== '#ffffff' ? row.color : '#ffffff'; 
                if (rawCrew) rowColor = '#fff9c4'; 
                if (rawBowser) rowColor = '#dcedc8'; 
                if (effectiveDepTime && (effectiveDepTime - now) / 60000 <= 10) rowColor = '#ffcdd2'; 

                return {
                    originalData: row.data,
                    flightNo: rawFlight,
                    cleanFlight: formatCleanFlight(rawFlight),
                    sector: rawSector,
                    percentile: rawPercent, // NEW
                    callSign: rawCall,
                    bay: rawBay,
                    crew: rawCrew,
                    bowser: rawBowser,
                    comment: rawComment,
                    effectiveDepTime: effectiveDepTime,
                    displayDepText: displayDepText,
                    isCalculated: isCalculated,
                    finalColor: rowColor,
                    isDivert: isDivert
                };
            }).sort((a, b) => {
                if (!a.effectiveDepTime) return 1;
                if (!b.effectiveDepTime) return -1;
                return a.effectiveDepTime - b.effectiveDepTime;
            });
        }

        function renderMasterBoard(processedData) {
            const tbody = document.querySelector('#flightTable tbody');
            tbody.innerHTML = '';
            processedData.forEach(item => {
                const tr = document.createElement('tr');
                tr.style.backgroundColor = item.finalColor;
                if (item.isDivert) tr.classList.add('diverted-text');

                // Construct columns in visual order A->J
                const colData = [
                    item.flightNo, 
                    item.displayDepText, 
                    item.sector, 
                    item.percentile, // New Col D
                    item.callSign, 
                    item.bay, 
                    formatTimeDisplay(item.originalData[6]), // ETA
                    item.crew, 
                    item.bowser, 
                    item.comment
                ];

                colData.forEach((cellData, index) => {
                    const td = document.createElement('td');
                    if (index === 1) { // Dep
                         td.textContent = cellData;
                         if (item.isCalculated) td.classList.add('bold-time');
                    } else if (index === 3) { // 95% Column
                        td.textContent = cellData;
                        td.style.fontWeight = "bold";
                        td.style.color = "#1565c0";
                    } else {
                        td.textContent = cellData;
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function renderRunningView(processedData) {
            const container = document.getElementById('runningContainer');
            const runningFlights = processedData.filter(item => item.bowser && item.bowser.toString().trim() !== "");
            
            document.getElementById('activeCount').textContent = runningFlights.length + " Running";

            if (runningFlights.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #888;"><h3>No Active Bays</h3><p>Enter a Bowser Number to see flights.</p></div>';
                return;
            }

            container.innerHTML = '';
            
            runningFlights.forEach(item => {
                const card = document.createElement('div');
                card.className = item.isDivert ? 'bay-card divert-card' : 'bay-card';
                if(item.finalColor === '#ffcdd2') card.style.borderLeftColor = 'red';

                const bayDisplay = item.bay ? "BAY " + item.bay : "NO BAY";
                let divertHtml = item.isDivert ? `<div class="divert-alert">‚ö†Ô∏è DIVERT: Check Bowser ${item.bowser}</div>` : '';

                card.innerHTML = `
                    <div class="bay-header">
                        <span class="bay-title">${bayDisplay}</span>
                        <span class="bay-bowser">üöõ ${item.bowser}</span>
                    </div>
                    ${divertHtml}
                    <div class="bay-body">
                        <div class="info-group">
                            <label>Flight <span class="copy-hint" onclick="copyToClipboard('${item.cleanFlight}')">(Copy)</span></label>
                            <span style="font-size: 18px;">${item.flightNo}</span>
                        </div>
                        <div class="info-group">
                            <label>Call Sign</label>
                            <span>${item.callSign}</span>
                        </div>
                        
                        <div class="stat-highlight">
                            <div class="info-group">
                                <label style="color:#1565c0">95th %</label>
                                <span class="stat-val">${item.percentile || "--"}</span>
                            </div>
                            <div class="info-group" style="text-align:right">
                                <label style="color:#1565c0">Departure</label>
                                <span style="${item.isCalculated ? 'color:red' : ''}">${item.displayDepText}</span>
                            </div>
                        </div>

                        <div class="info-group">
                            <label>Sector</label>
                            <span>${item.sector}</span>
                        </div>
                        <div class="crew-highlight info-group">
                            <label>Crew</label>
                            <span>${item.crew || '--'}</span>
                        </div>
                    </div>
                    <div class="bay-footer">
                        <strong>NOTE:</strong> ${item.comment || "No special instructions"}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderCrewSummary(flightList) {
            const tbody = document.querySelector('#crewTable tbody');
            const crewMap = {};
            // Crew is now Index 7 (row[7])
            flightList.forEach(row => {
                const flightNum = row.data[0]; 
                const crewName = row.data[7];  
                if (crewName && crewName.toString().trim() !== "") {
                    const name = crewName.toString().trim();
                    if (!crewMap[name]) crewMap[name] = [];
                    crewMap[name].push(flightNum);
                }
            });

            tbody.innerHTML = '';
            const sortedCrew = Object.keys(crewMap).sort();
            if (sortedCrew.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; color:#999;">No crew assigned</td></tr>';
                return;
            }
            sortedCrew.forEach(name => {
                const tr = document.createElement('tr');
                const tdName = document.createElement('td');
                tdName.textContent = name;
                tdName.style.fontWeight = 'bold';
                const tdFlights = document.createElement('td');
                tdFlights.textContent = crewMap[name].join(', ');
                tr.appendChild(tdName);
                tr.appendChild(tdFlights);
                tbody.appendChild(tr);
            });
        }

        fetchData();
        setInterval(fetchData, DATA_REFRESH_RATE);
        setTimeout(() => { window.location.reload(); }, PAGE_RELOAD_RATE);

    </script>
</body>
</html>
